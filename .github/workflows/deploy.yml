name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" 

      - name: Install dependencies
        run: pip install -r requirements.txt
        working-directory: app

      - name: Run tests
        run: pytest
        working-directory: app

  pre-deploy:
    name: Pre-deploy Checks
    needs: test
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Verify environment config
        env:
          TEST_SECRET: ${{ secrets.test }}
        run: |
          echo "Verifying environment configuration..."
          if [ -z "$TEST_SECRET" ]; then
            echo "Error: 'test' environment secret is not configured"
            exit 1
          fi
          echo "Environment config OK."

      - name: Pre-deploy health checks
        run: |
          echo "Running pre-deploy checks..."
          echo "Checking dependencies are up to date..."
          echo "Checking no migration drift..."
          echo "All pre-deploy checks passed."

  deploy:
    name: Deploy
    needs: pre-deploy
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt
        working-directory: app

      - name: Deploy
        run: |
          echo "Deploying app to production..."
          echo "App version: $(git rev-parse --short HEAD)"
          echo "Deploy complete."

  post-deploy:
    name: Post-deploy Verification
    needs: deploy
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Smoke tests
        run: |
          echo "Running post-deploy smoke tests..."
          echo "Checking / endpoint..."
          echo "Checking /health endpoint..."
          echo "All smoke tests passed."

      - name: Notify
        run: |
          echo "Production deployment verified."
          echo "Commit: $(git rev-parse --short HEAD)"
